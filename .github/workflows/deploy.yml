name: Deploy VIB

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /home/deploy/vib

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Update nginx config and enable maintenance mode
            echo "Updating nginx config..."
            cp server-configs/nginx/viktorbezai.online /etc/nginx/sites-available/viktorbezai.online
            nginx -t && systemctl reload nginx

            echo "Enabling maintenance mode..."
            cp server-configs/maintenance.html /var/www/maintenance-vib.html
            touch /var/www/maintenance-vib.flag

            # Create .env from secrets
            cat > .env << 'EOF'
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            ENVIRONMENT=production
            POSTGRES_NAME=${{ secrets.POSTGRES_NAME }}
            POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
            EOF

            # Create frontend env
            cat > frontend/.env.production << 'EOF'
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
            EOF

            # Build and restart containers
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml build
            docker-compose -f docker-compose.prod.yml up -d

            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 10

            # Disable maintenance mode
            echo "Disabling maintenance mode..."
            rm -f /var/www/maintenance-vib.flag

            # Cleanup
            docker image prune -f

            echo "Deployed successfully!"
